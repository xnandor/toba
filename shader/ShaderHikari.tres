[gd_resource type="CanvasItemMaterial" load_steps=2 format=1]

[sub_resource type="CanvasItemShader" id=1]

_code = {
"fragment": "float edge = 0.0;
float water = 0.0;
float a = 0.04;      // amplitude
float n = 4.0;      // number of fans
float o = TIME/2.0; // offset
float alpha = 1.0;
float u = 1.3*UV.x - 0.15;
float v = 1.3*UV.y - 0.15;
float direction = 1;
float fullW = u*n+o;
float w = mod(fullW, 2.0); // wave function
if (w > 1.0) {
	direction = -1;
	w = 2.0-w;
}
//a = a*(0.5*sin(3*(u)*3.1459)+0.5);
float newv = v+a*(w);
vec2 uv = vec2(u, newv);
vec2 wave = vec2(0.03*sin(9.2*u + TIME), 0.07*sin(22.2*u + TIME));
if (uv.y > 1.0) {
	if (alpha > 0.0) {
		alpha = 0.8;
	}
	water = 1.0;
}
if ((UV.y < 1.0 && UV.y > 0.8) && (UV.x < 0.115 || UV.x > 1-0.115)) {water = 1.0;}
if (uv.x > 1.0) {
	alpha = 0.0;
	if (water > 0.0) {
		alpha = 11-10*uv.x;
		alpha = pow(alpha, 4);
	}
	edge = 1.0;
}
if (uv.x < 0.0) {
	alpha = 0.0;
	if (water > 0) {
		alpha = 1+10*uv.x;
		alpha = pow(alpha, 4);
	}
	edge = 1.0;
}
if (water > 0) {
	uv = vec2(wave.x+u, wave.y+(2.0-newv));
}
if (uv.y < 0.0) {alpha = 0.0;}
if (uv.y > 1.0) {edge = 0.0;}
vec4 c = tex(TEXTURE, uv); // final color pre lighting
// Lighting
color waterColor = color(0.5, 1.2, 1.5, 1.0);
vec4 fluid = vec4(1.0, 1.0, 1.0, 1.0);
if (water > 0) {
	fluid = waterColor;
	float center = 1-2*pow(2*UV.x-1, 2.9);
	float strength = 32;
	float offset = 0.77;
	float bottom = 1-strength*pow(UV.y-offset, 1.8);
	fluid.a = 0.5*(center+bottom);
}
float cornerD = w;
float cornerShadow = 0.1*pow(cornerD, 8);
//if (edge > 0.0) {cornerShadow = 1.0;}
vec3 shadow = vec3(cornerShadow);
float direct = 0.0;
if (direction > 0) {direct = -0.1;}
if (direction < 0) {direct = 0.1;}
vec3 light = vec3(direct)+vec3(1.0-a);
c = fluid*vec4((c.rgb-shadow)*(light), alpha);
COLOR = c;",
"fragment_ofs": 0,
"light": "",
"light_ofs": 0,
"vertex": "",
"vertex_ofs": 0
}

[resource]

shader/shader = SubResource( 1 )
shader/shading_mode = 0

